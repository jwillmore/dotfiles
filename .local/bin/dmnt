#!/bin/bash

##################-dmount-##################
###############-by Jwillmore-###############
########-Released under MIT License-########


drives="$(lsblk -rpo "name,type,size,mountpoint" | grep 'part\|rom' | awk '$4==""{printf " %s (%s) \n",$1,$3}')"
udrives=$(lsblk -nrpo "name,type,size,mountpoint,label" | awk -F':' '{gsub(/ /,":")}$4!~/\/boot|\/efi|\/home$|SWAP/&&length($4)>1{printf "%s (%s) \n",$4,$3,$5}')
mnt=/run/media

mountd(){
  if [[ -z "$drives" ]]; then
  whiptail --title "Empty" --msgbox "There are no drives to mount." 0 0
  fi

  option=$(echo "$drives" | sort -V )
  drive=$(whiptail --title "Choose a drive to mount." --menu "" 0 0 0 $option 3>&1 1>&2 2>&3) || exit
fs_uuid=$(lsblk -no UUID "$drive")

    pass=$(whiptail --title "Authentication required" --passwordbox "Enter your password" 0 0 3>&1 1>&2 2>&3)

    exitstatus=$?
    if [ $exitstatus = 0 ]; then
        sudo -S <<< $pass sus
	sudo mkdir -p $mnt/"$fs_uuid"
	sudo mount "$drive" $mnt/"$fs_uuid"
	if mount | grep "$drive" > /dev/null; then
	  notify-send "  $drive mounted on $mnt/$fs_uuid"
	else
	  notify-send "  $drive failed to be mounted."
	fi
    else
        #Password If cancel
        whiptail --title "Cancel" --msgbox "Operation cancelled" 0 0
    fi
}

umountd(){
  if [[ -z "$udrives" ]]; then
  whiptail --title "Empty" --msgbox "There are no drives to unmount." 0 0
  fi

  option=$(echo "$udrives" | sort -V )
  drive=$(whiptail --title "Choose a drive to unmount." --menu "" 0 0 0 $option 3>&1 1>&2 2>&3) || exit

  pass=$(whiptail --title "Authentication required" --passwordbox "Enter your password." 0 0 3>&1 1>&2 2>&3)

    exitstatus=$?
    if [ $exitstatus = 0 ]; then
        sudo -S <<< $pass sus
	sudo umount "$drive"
	sudo rmdir "$drive"

	if [ ! -d "$drive" ]; then
	  notify-send "  $drive unmounted"
	else
	  notify-send "  $drive could not be unmounted."
	fi
    else
        #Password If cancel
        whiptail --title "Cancel" --msgbox "Operation cancelled" 0 0
    fi
}

  action=$(whiptail --title "dmount | by Jwillmore" --cancel-button "Exit" --menu '' 0 0 0 "Mount" "" "Unmount" "" 3>&1 1>&2 2>&3)
  if [ "$action" = "Mount" ]; then
    mountd
  elif [ "$action" = "Unmount" ]; then 
    umountd
  fi
